define("handy/base/1.1.0/page",["$","arale/base/1.0.1/base","arale/class/1.0.0/class","arale/events/1.0.0/events","./path","./navigation","./history"],function(e){var t,a=e("$"),r=e("arale/base/1.0.1/base"),n=e("./path"),i=e("./navigation"),s=a(window),o=r.extend({init:function(){this._initPages(),this._initEvents()},_initPages:function(){var e=this.pages=[];a.each(a(".page"),function(t,r){if(0===t)e.push({url:n.parseUrl(n.documentUrl.hrefNoHash),dom:a(r)});else{var i=a(r).data("url");i&&e.push({url:n.parseUrl(n.makeUrlAbsolute(i)),dom:a(r)})}}),this.activePage=this.pages[0]},_initEvents:function(){var e=this;s.on("navigate",function(t,a){var r=a.state,i=n.parseUrl(n.squash(location.href));i.hrefNoHash,"forward"===r.direction?e.forward(i):e.backward(i)}),a(document).on("click","[data-transition]",function(t){t.preventDefault(),e.forward(this.href)}),a(document).on("click","[data-rel=back]",function(e){e.preventDefault(),window.history.back()}),s.trigger("hashchange")},forward:function(e,t,r){if(!this.transiting&&e){this.transiting=!0;var i,s="object"===a.type(e)?e:n.parseUrl(n.squash(n.makeUrlAbsolute(e)));0>(i=this._getIndexByUrl(s))?this._createPage({url:s,data:t,post:r}):this.transition(this.pages[i])}},backward:function(e,t,r){if(!this.transiting)if(e){this.transiting=!0;var i,s="object"===a.type(e)?e:n.parseUrl(n.squash(n.makeUrlAbsolute(e)));0>(i=this._getIndexByUrl(s))?this._createPage({url:s,data:t,post:r},!0):this.transition(this.pages[i],!0)}else window.history.back()},transition:function(e,t){if(e!==this.activePage){var a=this,r=e.url,n=e.dom,s=this.activePage,o=s.dom,h=s.url,c=t?"page-slidetoright":"page-slidetoleft",u=t?"page-slidefromleft":"page-slidefromright";a.trigger("transiting"),o.addClass(c),n.on("animationend webkitAnimationEnd",function(t){o.removeClass("page-active "+c),n.removeClass(u).off("animationend webkitAnimationEnd",t.callee),a.activePage=e,o.data("cache")===!1&&(a.pages.splice(a._getIndexByUrl(h),1),o.remove()),a.transiting=!1,a.trigger("transition",e)}).addClass("page-active "+u),i.go(r,t)}},_getIndexByUrl:function(e){for(var t=this.pages,a=0,r=t.length;r>a;a++)if(e.hrefNoHash===t[a].url.hrefNoHash)return a;return-1},_createPage:function(e,t){this.trigger("loading"),a.ajax(e.url.href,{type:e.post?"post":"get",data:e.data,context:this,success:function(r){var n,i,s,o,h=a("<div></div>"),c=this.pages;n=r.match(/<title[^>]*>([^<]*)/)&&RegExp.$1,i=r.match(/<body[^>]*>([\s\S]*)<\/body>/gim)&&RegExp.$1,h.get(0).innerHTML=i,s=h.find("[data-role=page]").eq(0),e.post&&s.data("cache",!1),this.activePage.dom.after(s),o={url:e.url,dom:s},this.trigger("load",o),t?(c.unshift(o),this.transition(o,!0)):(c.push(o),this.transition(o))},error:function(){this.trigger("error",e),this.transiting=!1}})}});return t=new o}),define("handy/base/1.1.0/path",["$"],function(e){var t=e("$"),a=t("head").find("base"),r={urlParseRE:/^\s*(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,getLocation:function(e){var t=e?this.parseUrl(e):location,a=this.parseUrl(e||location.href).hash;return a="#"===a?"":a,t.protocol+"//"+t.host+t.pathname+t.search+a},parseLocation:function(){return this.parseUrl(this.getLocation())},parseUrl:function(e){if("object"===t.type(e))return e;var a=r.urlParseRE.exec(e||"")||[];return{href:a[0]||"",hrefNoHash:a[1]||"",hrefNoSearch:a[2]||"",domain:a[3]||"",protocol:a[4]||"",doubleSlash:a[5]||"",authority:a[6]||"",username:a[8]||"",password:a[9]||"",host:a[10]||"",hostname:a[11]||"",port:a[12]||"",pathname:a[13]||"",directory:a[14]||"",filename:a[15]||"",search:a[16]||"",hash:a[17]||""}},makePathAbsolute:function(e,t){if(e&&"/"===e.charAt(0))return e;e=e||"",t=t?t.replace(/^\/|(\/[^\/]*|[^\/]+)$/g,""):"";for(var a=t?t.split("/"):[],r=e.split("/"),n=0;r.length>n;n++){var i=r[n];switch(i){case".":break;case"..":a.length&&a.pop();break;default:a.push(i)}}return"/"+a.join("/")},isSameDomain:function(e,t){return r.parseUrl(e).domain===r.parseUrl(t).domain},isRelativeUrl:function(e){return""===r.parseUrl(e).protocol},isAbsoluteUrl:function(e){return""!==r.parseUrl(e).protocol},makeUrlAbsolute:function(e,t){if(!r.isRelativeUrl(e))return e;void 0===t&&(t=this.documentBase);var a=r.parseUrl(e),n=r.parseUrl(t),i=a.protocol||n.protocol,s=a.protocol?a.doubleSlash:a.doubleSlash||n.doubleSlash,o=a.authority||n.authority,h=""!==a.pathname,c=r.makePathAbsolute(a.pathname||n.filename,n.pathname),u=a.search||!h&&n.search||"",l=a.hash;return i+s+o+c+u+l},addSearchParams:function(e,a){var n=r.parseUrl(e),i="object"==typeof a?t.param(a):a,s=n.search||"?";return n.hrefNoSearch+s+("?"!==s.charAt(s.length-1)?"&":"")+i+(n.hash||"")},get:function(e){return void 0===e&&(e=r.parseLocation().hash),r.stripHash(e).replace(/[^\/]*\.[^\/*]+$/,"")},set:function(e){location.hash=e},isPath:function(e){return/\//.test(e)},clean:function(e){return e.replace(this.documentBase.domain,"")},stripHash:function(e){return e.replace(/^#/,"")},stripQueryParams:function(e){return e.replace(/\?.*$/,"")},cleanHash:function(e){return r.stripHash(e.replace(/\?.*$/,""))},isHashValid:function(e){return/^#[^#]+$/.test(e)},isExternal:function(e){var t=r.parseUrl(e);return t.protocol&&t.domain!==this.documentUrl.domain?!0:!1},hasProtocol:function(e){return/^(:?\w+:)/.test(e)},squash:function(e,t){var a,n,i,s=this.isPath(e),o=this.parseUrl(e),h=o.hash;return t=t||(r.isPath(e)?r.getLocation():r.getDocumentUrl()),n=s?r.stripHash(e):e,n=r.isPath(o.hash)?r.stripHash(o.hash):n,a=r.makeUrlAbsolute(n,t),i=this.parseUrl(a).search,s&&(r.isPath(h)&&(h=""),-1===h.indexOf("#")&&""!==h&&(h="#"+h),a=r.parseUrl(a),a=a.protocol+"//"+a.host+a.pathname+i+h),a}};return r.documentUrl=r.parseLocation(),r.documentBase=a.length?r.parseUrl(r.makeUrlAbsolute(a.attr("href"),r.documentUrl.href)):r.documentUrl,r.documentBaseDiffers=r.documentUrl.hrefNoHash!==r.documentBase.hrefNoHash,r.getDocumentUrl=function(e){return e?t.extend({},r.documentUrl):r.documentUrl.href},r.getDocumentBase=function(e){return e?t.extend({},r.documentBase):r.documentBase.href},r}),define("handy/base/1.1.0/navigation",["$","handy/base/1.1.0/path","handy/base/1.1.0/history"],function(e){var t,a=e("$"),r=e("handy/base/1.1.0/path"),n=e("handy/base/1.1.0/history"),i=a(window),s={currentHref:r.documentBase.hrefNoHash,go:function(e,t){var a=n.find(e.hrefNoHash);r.documentBase.hrefNoHash===e.hrefNoHash?r.set("#"):r.set("#"+e.pathname),0>a&&(t||n.clearForward(this.currentHref),n.add(e.hrefNoHash,t)),this.currentHref=e.hrefNoHash}};return i.on("hashchange",function(){var e=r.parseUrl(r.squash(location.href)).hrefNoHash;if(e===s.currentHref){if(t)return;n.add(e),t=!0}else{var i=n.find(s.currentHref),o=n.find(e);a(this).trigger("navigate",{state:{direction:o>-1&&i>o?"backward":"forward"}})}}),s}),define("handy/base/1.1.0/history",["$"],function(e){function t(){this._stack=[]}var a=e("$");return window.undefined,a.extend(t.prototype,{add:function(e,t){this._stack[t?"unshift":"push"](e)},clearForward:function(e){this._stack=this._stack.slice(0,this.find(e)+1)},find:function(e){return this._stack.indexOf(e)}}),new t});
